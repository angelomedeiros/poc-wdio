image: node:14.4

stages:
  - test
  - deploy

.e2e:base: &base
  stage: test
  script:
    - yarn
    - yarn test
  artifacts:
    expire_in: 30 days
    name: 'Reporters-$CI_JOB_NAME-$CI_COMMIT_REF_NAME__$CI_COMMIT_SHORT_SHA'
    when: always
    paths:
      - ./reporters

e2e:firefox:default:
  <<: *base
  services:
    - name: selenium/standalone-firefox
  variables:
    HOSTNAME_DRIVER_FIREFOX: selenium__standalone-firefox
  only:
    - pushes
  before_script:
    - echo $HOSTNAME_DRIVER_FIREFOX

e2e:chrome:default:
  <<: *base
  services:
    - name: selenium/standalone-chrome
  variables:
    HOSTNAME_DRIVER_CHROME: selenium__standalone-chrome
  only:
    - pushes
  before_script:
    - echo $HOSTNAME_DRIVER_CHROME

e2e:firefox:default2:
  <<: *base
  services:
    - name: selenium/standalone-firefox
  variables:
    HOSTNAME_DRIVER_FIREFOX: selenium__standalone-firefox
  before_script:
    - echo $HOSTNAME_DRIVER_FIREFOX

e2e:chrome:default2:
  <<: *base
  services:
    - name: selenium/standalone-chrome
  variables:
    HOSTNAME_DRIVER_CHROME: selenium__standalone-
  before_script:
    - echo $HOSTNAME_DRIVER_CHROME

e2e:firefox:develop:
  <<: *base
  services:
    - name: selenium/standalone-firefox
  variables:
    HOSTNAME_DRIVER_FIREFOX: selenium__standalone-firefox
  only:
    - develop
  except:
    - pushes

e2e:chrome:develop:
  <<: *base
  services:
    - name: selenium/standalone-chrome
  variables:
    HOSTNAME_DRIVER_CHROME: selenium__standalone-chrome
  only:
    - develop
  except:
    - pushes

e2e:firefox:stage:
  <<: *base
  services:
    - name: selenium/standalone-firefox
  variables:
    HOSTNAME_DRIVER_FIREFOX: selenium__standalone-firefox
  only:
    - stage
  except:
    - pushes

e2e:chrome:stage:
  <<: *base
  services:
    - name: selenium/standalone-chrome
  variables:
    HOSTNAME_DRIVER_CHROME: selenium__standalone-chrome
  only:
    - stage
  except:
    - pushes

e2e:firefox:master:
  <<: *base
  services:
    - name: selenium/standalone-firefox
  variables:
    HOSTNAME_DRIVER_FIREFOX: selenium__standalone-firefox
  only:
    - master
  except:
    - pushes

e2e:chrome:master:
  <<: *base
  services:
    - name: selenium/standalone-chrome
  variables:
    HOSTNAME_DRIVER_CHROME: selenium__standalone-chrome
  only:
    - master
  except:
    - pushes

pages:
  image: openjdk:15-alpine
  stage: deploy
  when: always
  artifacts:
    name: 'Allure-$CI_JOB_NAME-$CI_COMMIT_REF_NAME__$CI_COMMIT_SHORT_SHA'
    paths:
      - public
  variables:
    GIT_STRATEGY: none
  script:
    - apk add --update nodejs nodejs-npm
    - npx allure-commandline generate reporters/allure
    - mv ./allure-report public
